<html>
<head>
  <title>Analytics</title>
  <link href='http://fonts.googleapis.com/css?family=Arbutus+Slab' rel='stylesheet' type='text/css'>
  <style type="text/css">
    html { height: 100% }
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Arbutus Slab', serif;
    }
    #map_canvas { height: 100%; }
    #wrapper {
      font-family: ;
      padding: 20px;
      position: absolute;
      top: 10%;
      right: 20%;
      background-color: white;
      z-index: 100;

      -webkit-border-radius: 10px;
      -moz-border-radius: 10px;
      border-radius: 10px;
    }

    .table { width: 100%; }
    .percentage { float: right; }
    p { border-bottom: 1px solid grey; line-height: 150%; }
  </style>
</head>
<body>
  <div id="wrapper">
    <h1>Top sources</h1>
    <div id="topvisits">


    </div>
  </div>
    
  <div id="map_canvas"></div>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
  <script src="//maps.google.com/maps/api/js?key=api key&sensor=false"></script>
  
  <script type="text/javascript">    
    var totalVisits = 1;
    var map;
    var markers = [];
    var topvisits = [];

    var stylesArray = [
      {
        "featureType": "road",
        "stylers": [
          { "color": "#808080" },
          { "visibility": "off" }
        ]
      },{
        "featureType": "poi",
        "stylers": [
          { "visibility": "off" }
        ]
      },{
        "featureType": "administrative.province",
        "stylers": [
          { "visibility": "off" }
        ]
      },{
        "featureType": "administrative.country",
        "elementType": "geometry.fill",
        "stylers": [
          { "visibility": "on" }
        ]
      },{
        "featureType": "administrative.locality",
        "elementType": "labels",
        "stylers": [
          { "visibility": "off" }
        ]
      }
    ];

    var source = new EventSource('http://localhost:1337');

    $(document).ready(function(){
      map = new google.maps.Map(document.getElementById("map_canvas"), {
        zoom: 6,
        center: new google.maps.LatLng('54', '3'),
        mapTypeId: google.maps.MapTypeId.ROADMAP
      });
      map.setOptions({styles: stylesArray});
    });

    source.onopen = function (e) {
      console.log('new connection');        
    };

    source.onmessage = function (e) {          
      var visitMsgs = JSON.parse(e.data);
      
      for (var i = 0; i < visitMsgs.length; i++) {        
        
        //http://api.ipinfodb.com/v3/ip-city/?key=412188ad591298ddd12b5ab67f6523bb7b89075d4f81965a15a7d4b985e0a994&ip='+ visitMsgs[i]ipaddress +'&format=json'
        //http://freegeoip.net/json/' + visitMsgs[i].ipaddress

        $.getJSON('http://api.ipinfodb.com/v3/ip-city/?key=412188ad591298ddd12b5ab67f6523bb7b89075d4f81965a15a7d4b985e0a994&ip=' + visitMsgs[i].ipaddress + '&format=json', function (data) {
          var image = 'http://i.imgur.com/0AynL.png';
          var marker = new google.maps.Marker({
            position: new google.maps.LatLng(data.latitude, data.longitude),
            map: map,
            icon: image,
            time: new Date()
          });

          markers.push(marker);
        });

        topvisits = visitEventCounter.Counter(visitMsgs[i]);

        $('#topvisits').html("");
        for (var y = 0; y < 5; y++) {
          $('#topvisits').append("<p class='table'>" + (y+1) + ": " + topvisits[y][1] + "<span class='percentage'>" + Math.round(((topvisits[y][0] / totalVisits).toFixed(2))*100) + "%</span></p>");
        }
      }

      // remove markers older than 20mins
      var toRemove = jQuery.grep(markers, function (marker, index) {
        var now = new Date();        
        var cutOff = new Date(now);
        cutOff.setMinutes(now.getMinutes() - 20);
        
        return (marker.time < cutOff);
      });

      $.each(toRemove, function () {
        this.setMap(null);
      });
    }

    source.onerror = function (e) {
      if (e.readyState == EventSource.CLOSED) {
        console.log("connection closed");
      }
    };



var visitEventCounter = {
  Counter: function (visit) {
    totalVisits = 1;

    var obj = new Array(0);
    obj[0] = 1;
    obj[1] = visit.mediasource;
    var hit = false;
    for (var y = 0; y < topvisits.length; y++) {
      totalVisits = totalVisits + topvisits[y][0]
      
      if (topvisits[y][1] === visit.mediasource) {
        obj[0] = topvisits[y][0] + 1;
        topvisits[y] = obj;
        hit = true;
      }
    }
    if (hit === false) {
      topvisits[topvisits.length] = obj;
    }
    topvisits.sort(function (a, b) {
      return (a[0] > b[0] ? -1 : (a[0] < b[0] ? 1 : 0));
    });
    return topvisits;
  }
}






  </script>
</body>
</html>
