<html>
<head>
  <title>Analytics</title>
  <style type="text/css">
    html { height: 100% }
    body { height: 100%; margin: 0; padding: 0 }
    #map_canvas { height: 100%; }
    #wrapper { position: absolute; bottom: 0; right: 0; }
  </style>
</head>
<body>
  <div id="wrapper">
    <h1>Real-Time Visits</h1>
  </div>
    
  <div id="map_canvas"></div>
  <div id="messages"></div>    

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
  <script src="//maps.google.com/maps/api/js?key=apikey&sensor=false"></script>
  
  <script type="text/javascript">    
    var map;
    var markers = [];

    var source = new EventSource('http://localhost:1337');

    $(document).ready(function(){
      map = new google.maps.Map(document.getElementById("map_canvas"), {
        zoom: 6,
        center: new google.maps.LatLng('54', '3'),
        mapTypeId: google.maps.MapTypeId.ROADMAP
      });
    });

    source.onopen = function (e) {
      console.log('new connection');        
    };

    source.onmessage = function (e) {          
      var visitMsgs = JSON.parse(e.data);
      
      for (var i = 0; i < visitMsgs.length; i++) {        
        $.getJSON('http://freegeoip.net/json/' + visitMsgs[i].ipaddress, function (data) {
          var marker = new google.maps.Marker({
            position: new google.maps.LatLng(data.latitude, data.longitude),
            map: map,
            time: new Date()
          });

          markers.push(marker);
        });
      }

      // remove markers older than 20mins
      var toRemove = jQuery.grep(markers, function (marker, index) {
        var now = new Date();        
        var cutOff = new Date(now);
        cutOff.setMinutes(now.getMinutes() - 20);
        
        return (marker.time < cutOff);
      });

      $.each(toRemove, function () {
        this.setMap(null);
      });
    }

    source.onerror = function (e) {
      if (e.readyState == EventSource.CLOSED) {
        console.log("connection closed");
      }
    };
  </script>
</body>
</html>
