<html>
<head>
  <title>Analytics</title>
  <link href='http://fonts.googleapis.com/css?family=Droid+Serif:700' rel='stylesheet' type='text/css'>
  <style type="text/css">
    html { height: 100% }
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Droid Serif', serif;
    }
    #map_canvas { height: 100%; }
    #wrapper {
      width: 300px;
      padding: 20px;
      position: absolute;
      top: 60px;
      right: 80px;
      background-color: white;
      z-index: 100;

      -webkit-border-radius: 10px;
      -moz-border-radius: 10px;
      border-radius: 10px;
      -webkit-box-shadow: 8px 8px 8px 0px #666;
      -moz-box-shadow: 8px 8px 8px 0px #666;
      box-shadow: 8px 8px 8px 0px #666;
    }

    #count {
      width: 150px;
      padding: 10px;
      position: absolute;
      top: 30px;
      left: 120px;
      background-color: white;
      z-index: 100;

      -webkit-border-radius: 10px;
      -moz-border-radius: 10px;
      border-radius: 10px;
      -webkit-box-shadow: 8px 8px 8px 0px #666;
      -moz-box-shadow: 8px 8px 8px 0px #666;
      box-shadow: 8px 8px 8px 0px #666;
    }

    .table { width: 100%; }
    .percentage { float: right; }
    p { border-bottom: 1px solid grey; line-height: 150%; }
  </style>
</head>
<body>
  
  <div id="count">

  </div>

  <div id="wrapper">
    <h1 style="font-size:42px;">Top 5 sources</h1>
    <div id="topvisits">
    </div>
  </div>
    
  <div id="map_canvas"></div>

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.1/jquery.min.js"></script>
  <script src="//maps.google.com/maps/api/js?key=-Lgf3ec&sensor=false"></script>
  
  <script type="text/javascript">    
    var totalVisits;
    var map;
    var markers = [];
    var topvisits = [];

    var stylesArray = [
      {
        "featureType": "road",
        "stylers": [
          { "color": "#808080" },
          { "visibility": "off" }
        ]
      },{
        "featureType": "poi",
        "stylers": [
          { "visibility": "off" }
        ]
      },{
        "featureType": "administrative.province",
        "stylers": [
          { "visibility": "off" }
        ]
      },{
        "featureType": "administrative.country",
        "elementType": "geometry.fill",
        "stylers": [
          { "visibility": "on" }
        ]
      },{
        "featureType": "administrative.locality",
        "elementType": "labels",
        "stylers": [
          { "visibility": "off" }
        ]
      },{
        "featureType": "administrative.country",
        "elementType": "labels",
        "stylers": [
          { "visibility": "off" }
        ]
      }
    ];

    var source = new EventSource('http://luma-bunnies.herokuapp.com/');

    $(document).ready(function(){
      map = new google.maps.Map(document.getElementById("map_canvas"), {
        zoom: 6,
        center: new google.maps.LatLng('55.5', '-1.4'),
        mapTypeId: google.maps.MapTypeId.ROADMAP
      });
      map.setOptions({styles: stylesArray});
    });

    source.onopen = function (e) {
      console.log('new connection');        
    };

    source.onmessage = function (e) {          
      var visitMsgs = JSON.parse(e.data);

      for (var i = 0; i < visitMsgs.length; i++) {        
        var geoService = 'http://api.ipinfodb.com/v3/ip-city/?key=412188ad591298ddd12b5ab67f6523bb7b89075d4f81965a15a7d4b985e0a994&ip=' + visitMsgs[i].ipaddress + '&format=json';

        if (markers.length % 2 !== 0) {
          geoService = 'http://freegeoip.net/json/' + visitMsgs[i].ipaddress;
        }

        console.log(geoService);

        $.ajax({
          type: 'GET',
          url: geoService , 
          dataType: 'jsonp',
          success: function (data) {
            var image = 'http://i.imgur.com/0AynL.png';
            var marker = new google.maps.Marker({
              position: new google.maps.LatLng(data.latitude, data.longitude),
              map: map,
              icon: image,
              time: new Date()
            });

            markers.push(marker);
          }
        });

        topvisits = visitEventCounter.Counter(visitMsgs[i]);

        $('#topvisits').html("");
        var total = 0;
        for (var y = 1; y <= 5; y++) {
          var percentage = parseFloat((topvisits[y-1][0] / totalVisits)*100);
          total = total + percentage;

          $('#topvisits').append("<p class='table'>" + y + ": " + (topvisits[y-1][1] == null ? 'no source' : topvisits[y-1][1]) + "<span class='percentage'>" + percentage.toFixed(2) + "%</span></p>");
        }
        $('#topvisits').append("<p class='table'>Total: <span class='percentage'>" + total.toFixed(0) + "%</span></p>");
      }

      // remove markers older than 20mins
      var toRemove = jQuery.grep(markers, function (marker, index) {
        var now = new Date();        
        var cutOff = new Date(now);
        cutOff.setSeconds(now.getSeconds() - 60);
        
        return (marker.time < cutOff);
      });

      $.each(toRemove, function () {
        if (markers.indexOf(this) >= 0) {
          markers[markers.indexOf(this)].setMap(null);
          markers.splice(markers.indexOf(this), 1);
        }
      });

      toRemove = [];

      $('#count').html("<h1 style='font-size: 52px; padding: 3px; margin: 3px'>" + (markers.length).toFixed(1) + "</h1> pageviews / min");
    }

    source.onerror = function (e) {
      if (e.readyState == EventSource.CLOSED) {
        console.log("connection closed");
      }
    };

    var visitEventCounter = {
      Counter: function (visit) {
        totalVisits = 1;

        var obj = new Array(0);
        obj[0] = 1;
        obj[1] = visit.mediasource;
        var hit = false;
        for (var y = 0; y < topvisits.length; y++) {
          totalVisits = totalVisits + topvisits[y][0]
          
          if (topvisits[y][1] === visit.mediasource) {
            obj[0] = topvisits[y][0] + 1;
            topvisits[y] = obj;
            hit = true;
          }
        }
        if (hit === false) {
          topvisits[topvisits.length] = obj;
        }
        topvisits.sort(function (a, b) {
          return (a[0] > b[0] ? -1 : (a[0] < b[0] ? 1 : 0));
        });
        return topvisits;
      }
    }
  </script>
</body>
</html>
